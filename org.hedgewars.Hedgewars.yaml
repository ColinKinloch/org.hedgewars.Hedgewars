app-id: org.hedgewars.Hedgewars
runtime: org.kde.Platform
runtime-version: '5.12'
sdk: org.kde.Sdk
command: hedgewars
rename-desktop-file: hedgewars.desktop
rename-icon: hedgewars
rename-appdata-file: hedgewars.appdata.xml
finish-args:
  - --socket=x11
  - --share=ipc
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --share=network
  - --persist=.hedgewars
modules:
  - shared-modules/glew/glew.json

  - shared-modules/glu/glu-9.0.0.json

  - name: lua51
    sources:
      - type: archive
        url: https://www.lua.org/ftp/lua-5.1.5.tar.gz
        sha256: 2640fc56a795f29d28ef15e13c34a47e223960b0240e8cb0a82d9b0738695333
      - type: patch
        path: lua51-cflags.patch
      - type: patch
        path: lua51-prefix.patch
      - type: patch
        path: lua51-so.patch
      - type: shell
        commands:
          - sed -e 's:llua:llua5.1:' -e 's:/include:/include/lua5.1:' -i etc/lua.pc
          - sed -r -e '/^LUA_(SO|A|T)=/ s/lua/lua5.1/' -e '/^LUAC_T=/ s/luac/luac5.1/' -i src/Makefile
          - mv doc/lua.1 doc/lua5.1.1
          - mv doc/luac.1 doc/luac5.1.1
    cleanup:
      - /bin
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig
      - /share/man
    buildsystem: simple
    build-commands:
      - make CFLAGS='-O2 -Wall -fPIC' linux
      - make TO_BIN='lua5.1 luac5.1' TO_LIB='liblua5.1.a liblua5.1.so liblua5.1.so.5.1
        liblua5.1.so.5.1.5' INSTALL_TOP='/app' INSTALL_INC='/app/include/lua5.1' TO_MAN='lua5.1.1
        luac5.1.1' INSTALL_MAN='/app/share/man/man1' install
      - install -Dm0644 etc/lua.pc /app/lib/pkgconfig/lua51.pc
      - ln -s liblua5.1.so /app/lib/liblua.so.5.1
      - ln -s liblua5.1.so /app/lib/liblua.so.5.1.5

  - name: physicsfs
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://www.icculus.org/physfs/downloads/physfs-3.0.2.tar.bz2
        sha256: 304df76206d633df5360e738b138c94e82ccf086e50ba84f456d3f8432f9f863
    cleanup:
      - /bin
      - /include
      - /lib/*.a
      - /lib/pkgconfig

  - name: haskell
    buildsystem: simple
    sources:
      - type: archive
        url: https://downloads.haskell.org/~ghc/8.6.4/ghc-8.6.4-x86_64-deb9-linux.tar.xz
        sha256: ef74222ef3c01c3fc5b926f67e8b4ef612fe8efa40ac937317cff9b0eed8d863
        only-arches:
          - x86_64
      - type: archive
        url: https://downloads.haskell.org/~ghc/8.6.4/ghc-8.6.4-i386-deb9-linux.tar.xz
        sha256: 5e2ce88f4d13d23ac37e278e0c7b51c801008931359b9fa8a631d804d2da552c
        only-arches:
          - i386
    build-commands:
      - install -d /app/lib
      - ln -s /usr/lib/*-linux-gnu/libtinfo.so.6 /app/lib/libtinfo.so.5
      - ./configure --prefix=/app
      -  make install
    cleanup:
      - '*'

  - name: haskell-primitive
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/primitive-0.6.4.0/primitive-0.6.4.0.tar.gz
        sha256: 4cbeaf7924dd79221f327ea101a29bf35c4976dc3319df157ff46ea68e6a0c64
      - type: shell
        commands:
          - sed -e 's/< *4.12/<5/' -i primitive.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-vector
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/vector-0.12.0.2/vector-0.12.0.2.tar.gz
        sha256: 52e89dacaff10bedb8653181963cae928f9674a099bb706713dae83994bbc0f3
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-network
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/network-2.8.0.0/network-2.8.0.0.tar.gz
        sha256: c8905268b7e3b4cf624a40245bf11b35274a6dd836a5d4d531b5760075645303
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-random
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/random-1.1/random-1.1.tar.gz
        sha256: b718a41057e25a3a71df693ab0fe2263d492e759679b3c2fea6ea33b171d3a5a
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-transformers-compat
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/transformers-compat-0.6.2/transformers-compat-0.6.2.tar.gz
        sha256: dc06228b7b8a546f9d257b4fe2b369fc2cb279240bbe4312aa8f47bb2752e4be
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-exceptions
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/exceptions-0.10.1/exceptions-0.10.1.tar.gz
        sha256: 3ba4032df6b115bab1dad294948cf43fb9e1f566d3c513e9e1c363131739df9d
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-hashable
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/hashable-1.2.7.0/hashable-1.2.7.0.tar.gz
        sha256: ecb5efc0586023f5a0dc861100621c1dbb4cbb2f0516829a16ebac39f0432abf
      - type: shell
        commands:
          - sed -e 's/< *4.12/<5/' -i hashable.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-split
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/split-0.2.3.3/split-0.2.3.3.tar.gz
        sha256: 1dcd674f7c5f276f33300f5fd59e49d1ac6fc92ae949fd06a0f6d3e9d9ac1413
      - type: shell
        commands:
          - sed -e 's/< *4.12/<5/' -i split.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-unordered-containers
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/unordered-containers-0.2.9.0/unordered-containers-0.2.9.0.tar.gz
        sha256: 6730cb5c4a3e953e2c199d6425be08fd088ff0089a3e140d63226c052e318250
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-vector-algorithms
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/vector-algorithms-0.8.0.1/vector-algorithms-0.8.0.1.tar.gz
        sha256: 15bcde786dcf03861946885e030d3dbe3b683e1a6fc12d7317e115084f4637fe
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-mono-traversable
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/mono-traversable-1.0.11.0/mono-traversable-1.0.11.0.tar.gz
        sha256: c1a0d727a06131174bf6da3733084c284ec70e4f6aa398981e8ba5d4289137d2
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-unliftio-core
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/unliftio-core-0.1.2.0/unliftio-core-0.1.2.0.tar.gz
        sha256: 24c38b3d610ca2642ed496d1de3d7b6b398ce0410aa0a15f3c7ce636ba8f7a78
      - type: shell
        commands:
          - sed -e 's/<.*4.12/<5/' -i unliftio-core.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-resourcet
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/resourcet-1.2.2/resourcet-1.2.2.tar.gz
        sha256: 1323425aba3827479eb3588efaf7608b12a083327d64ec814f02863c3673cbe5
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-conduit
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/conduit-1.3.1.1/conduit-1.3.1.1.tar.gz
        sha256: 84dfafc92e9553c7bae4b4fe0cba3da29b37def606f88b989db95ee2dc933fa2
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-sandi
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/sandi-0.5/sandi-0.5.tar.gz
        sha256: 4940a19fe9c5e9b08a9f139a0806a30b956d007efa973f3763bed3165154afd9
    build-commands:
      - echo -e "import Distribution.Simple\nmain = defaultMain" > Setup.hs
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-old-locale
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/old-locale-1.0.0.7/old-locale-1.0.0.7.tar.gz
        sha256: dbaf8bf6b888fb98845705079296a23c3f40ee2f449df7312f7f7f1de18d7b50
      - type: shell
        commands:
          - sed -e 's/base >= 4.2 && < 4.9/base >= 4.2/' -i old-locale.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-hslogger
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/hslogger-1.2.12/hslogger-1.2.12.tar.gz
        sha256: f97a4c89d0921f237999de5d44950127dbe8baa177960ccccbfb79cccfd46c7a
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-utf8-string
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/utf8-string-1.0.1.1/utf8-string-1.0.1.1.tar.gz
        sha256: fb0b9e3acbe0605bcd1c63e51f290a7bbbe6628dfa3294ff453e4235fbaef140
      - type: shell
        commands:
          - sed -e 's/base >= 4.3 && < 4.9/base >= 4.3/' -i utf8-string.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-SHA
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/SHA-1.6.4.4/SHA-1.6.4.4.tar.gz
        sha256: 6bd950df6b11a3998bb1452d875d2da043ee43385459afc5f16d471d25178b44
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-entropy
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/entropy-0.4.1.4/entropy-0.4.1.4.tar.gz
        sha256: 2e3f6a65c8fde3551a8fb03b0a519b718762fc3278b1a5750f96d399e821eeb9
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-zlib
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/zlib-0.6.2/zlib-0.6.2.tar.gz
        sha256: 0dcc7d925769bdbeb323f83b66884101084167501f11d74d21eb9bc515707fed
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-regex-base
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/regex-base-0.93.2/regex-base-0.93.2.tar.gz
        sha256: 20dc5713a16f3d5e2e6d056b4beb9cfdc4368cd09fd56f47414c847705243278
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-regex-tdfa
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/regex-tdfa-1.2.3.1/regex-tdfa-1.2.3.1.tar.gz
        sha256: 8aaaeeecf050807c7c514d4dd1763ac63bd121782de5a0847bef5d48a095ea50
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: imagemagick
    config-opts:
      - --disable-dependency-tracking
      - --enable-static=no
      - --disable-docs
      - --without-magick-plus-plus
      - --without-bzlib
      - --with-x=no
      - --without-zlib
      - --without-zstd
      - --without-dps
      - --without-fftw
      - --without-flif
      - --without-fpx
      - --without-djvu
      - --without-fontconfig
      - --without-freetype
      - --without-raqm
      - --with-gvc=no
      - --without-heic
      - --without-jbig
      - --without-jpeg
      - --without-lcms
      - --without-openjp2
      - --without-lqr
      - --without-lzma
      - --without-openexr
      - --without-pango
      - --without-raw
      - --without-tiff
      - --without-webp
      - --with-wmf=no
      - --without-xml
    sources:
      - type: archive
        url: https://imagemagick.org/download/ImageMagick-7.0.8-39.zip
        sha256: 4508189b9c87012464613861826ac7a557cf78206b0e6ff3782410a13f621488
    cleanup:
      - '*'

  - name: hedgewars
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_ENGINE_C=1
    post-install:
      - |
        for _size in 16 32 48 64 128 256 512; do
          convert +set date:create +set date:modify misc/hedgewars.png -resize ${_size}x${_size} hedgewars_${_size}.png
          install -Dm0644 hedgewars_${_size}.png /app/share/icons/hicolor/${_size}x${_size}/apps/hedgewars.png
        done
    sources:
      - type: archive
        url: https://www.hedgewars.org/download/releases/hedgewars-src-0.9.25.tar.bz2
        sha256: b35d7334b6785305dd4f0129b646d1277ad58528cf8029b05bf642e02f76a723
      - type: patch
        path: hedgewars-appdata.patch
    cleanup:
      - /share/pixmaps
